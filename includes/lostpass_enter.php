<?php
/**
* @ Project: ID Account System 1.5.0
* @ Author: Yplitgroup (c)2012
* @ Email: yplitgroup@gmail.com
* @ Website: http://lemon9x.com 
* @ Phone: 0166.26.26.009
* @ Project ID: 876609683c4c7e392848e94d9f62e149
**/
// ############### CHECK ##############if( !defined('IS_MAIN') ) die(" Stop!!! ");if( defined( 'IS_USER' ) ) yplitgroupRedirectManager();if( !intval( $_GET['u'] ) or empty( $_GET['k'] ) ){	$yplitgroupError = $lang['404_notfound'];	$yplitgroupPageTitle = $lang['404_notfound'];	$f->load('yplitgroupThemesHeader');	require_once( DIR . '/skin/' . SKINDIR . '/lostpass_error.php' );	$f->load('yplitgroupThemesFooter');	exit;}$k = $f->load( 'unhtmlspecialchars', array( $_GET['k'] ) );$userid = intval( $_GET['u'] );if( $f->load( 'yplitgroupGetDbName' ) != 'vbb' )	$f->load( 'yplitgroupChangeDb', array( 'vbb' ) );$q = "SELECT `userid` FROM `". TABLE_PREFIX ."user` WHERE `userid` = " . $userid;$db->query( $q );if( $db->nums() == 0 ){ 	$yplitgroupError = $lang['404_notfound'];	$yplitgroupPageTitle = $lang['error_notice'];	$f->load('yplitgroupThemesHeader');	require_once( DIR . '/skin/' . SKINDIR . '/lostpass_error.php' );	$f->load('yplitgroupThemesFooter');	exit;}$db->query( "SELECT activationid, dateline FROM " . TABLE_PREFIX . "useractivation WHERE type = 1 AND userid = $userid" );if( $db->nums() == 0 ){ 	$yplitgroupError = $lang['404_notfound'];	$yplitgroupPageTitle = $lang['error_notice'];	$f->load('yplitgroupThemesHeader');	require_once( DIR . '/skin/' . SKINDIR . '/lostpass_error.php' );	$f->load('yplitgroupThemesFooter');	exit;}$user = $db->sql_fetch_assoc();if ($user['dateline'] < (TIMENOW - 48 * 60 * 60)){  // is it older than 48 hours?	$yplitgroupError = $lang['your_active_code_older_than_48h'];	$yplitgroupPageTitle = $lang['error_notice'];	$f->load('yplitgroupThemesHeader');	require_once( DIR . '/skin/' . SKINDIR . '/lostpass_error.php' );	$f->load('yplitgroupThemesFooter');	exit;}if( $k != $user['activationid'] ){	 //wrong act id	$yplitgroupError = $lang['your_active_code_error'];	$yplitgroupPageTitle = $lang['error_notice'];	$f->load('yplitgroupThemesHeader');	require_once( DIR . '/skin/' . SKINDIR . '/lostpass_error.php' );	$f->load('yplitgroupThemesFooter');	exit;}// delete old activation id$db->query("DELETE FROM " . TABLE_PREFIX . "useractivation WHERE userid = $userid AND type = 1");$newpassword = $f->load( 'yplitgroupFetchRandomPassword', 8 );// Update Password$db->query( "SELECT `username`, `salt`, `email` FROM `". TABLE_PREFIX ."user` WHERE `userid` = $userid" );$data = $db->sql_fetch_assoc();$db->query( "UPDATE `". TABLE_PREFIX ."user` SET `password` = ". $db->e( md5( md5( $newpassword ) . $data['salt'] ) ) .", `passworddate` = '". date("Y",time()) . '-' . date('m',time()) . '-' . date('d',time()) ."' WHERE `userid` = $userid" );$username = $f->load( 'unhtmlspecialchars', array( $data['username'] ) );$password = $newpassword;$subject = $lang['lostpass_email_subject_ok'] . ' - ' . $f->load( 'yplitgroupCreateAlias', array( $lang['lostpass_email_subject_ok'] ) );$link = $config['id_url'] . '/index.php?do=manager&page=editpass';$url = @parse_url( $config['id_url'] );$forum_title = ucfirst( $url['host'] );eval( '$message = "' . $lang['lostpass_email_body_ok'] . '";' );$message = $message . "\n-----------------------------------\n" . $f->load( 'yplitgroupCreateAlias', array( $message ) );yplitgroupSendmail( $data['email'], $subject, $message, array( 'email'=>'yplitgroup@gmail.com', 'name' => 'Yplitgroup' ) );	$yplitgroupLostPassMessage = $lang['your_password_have_been_reset'];	$f->load('yplitgroupThemesHeader');	require_once( DIR . '/skin/' . SKINDIR . '/lostpass_successfully.php' );	$f->load('yplitgroupThemesFooter');?>